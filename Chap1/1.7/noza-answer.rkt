#lang racket

(define (sqrt-iter guess x)
  (newline)
  (display "guess: ")
  (display guess)
  (newline)
  (sleep 1)
  (if (good-enough? guess x)
      guess
      (sqrt-iter (improve guess x) x)))

(define (improve guess x)
  (display "(/ x guess): ")
  (display (/ x guess))
  (newline)
  (display "next guess: ")
  (display (average guess (/ x guess)))
  (newline)
  (average guess (/ x guess)))

(define (average x y)
  (/ (+ x y) 2))

(define (good-enough? guess x)
  (< (abs (- (square guess) x)) 0.001))

(define (my-sqrt x)
  (sqrt-iter 1.0 x))

(define (square x) (* x x))

;; ここまで本の内容の実装（極端に値が大きい場合を検討するためデバッグの表示を含んでいる）

; 極端に値が小さい場合
;(my-sqrt 0.002) ; A. 差が0.001以下の正確性でも求めようとすると近似値が取れなくなる

; 極端に値が大きい場合
;(my-sqrt 10000000000000000000000000000000000000000000000000) ; 途中から同じ値がguessとなり止まらない
; guess improveの引数 次の guess を書き出してみると以下のようになる
;guess: 1.0
;(/ x guess): 1e+49
;next guess: 5e+48
;
;guess: 5e+48
;(/ x guess): 2.0
;next guess: 2.5e+48
;
;guess: 2.5e+48
;(/ x guess): 4.0
;next guess: 1.25e+48
;
;guess: 1.25e+48
;(/ x guess): 8.0
;next guess: 6.25e+47
;
;guess: 6.25e+47
;(/ x guess): 16.0
;next guess: 3.125e+47
;
;guess: 3.125e+47
;(/ x guess): 32.0
;next guess: 1.5625e+47
;
;guess: 1.5625e+47
;(/ x guess): 64.0
;next guess: 7.8125e+46
;
;guess: 7.8125e+46
;(/ x guess): 128.0
;next guess: 3.90625e+46
;
;guess: 3.90625e+46
;(/ x guess): 256.0
;next guess: 1.953125e+46
;
;guess: 1.953125e+46
;(/ x guess): 512.0
;next guess: 9.765625e+45
;
;guess: 9.765625e+45
;(/ x guess): 1024.0
;next guess: 4.8828125e+45
;
;guess: 4.8828125e+45
;(/ x guess): 2048.0
;next guess: 2.44140625e+45
;
;guess: 2.44140625e+45
;(/ x guess): 4096.0
;next guess: 1.220703125e+45
;
;guess: 1.220703125e+45
;(/ x guess): 8192.0
;next guess: 6.103515625e+44
;
;guess: 6.103515625e+44
;(/ x guess): 16384.0
;next guess: 3.0517578125e+44
;
;guess: 3.0517578125e+44
;(/ x guess): 32768.0
;next guess: 1.52587890625e+44
;
;guess: 1.52587890625e+44
;(/ x guess): 65536.0
;next guess: 7.62939453125e+43
;
;guess: 7.62939453125e+43
;(/ x guess): 131072.0
;next guess: 3.814697265625e+43
;
;guess: 3.814697265625e+43
;(/ x guess): 262144.0
;next guess: 1.9073486328125e+43
;
;guess: 1.9073486328125e+43
;(/ x guess): 524288.0
;next guess: 9.5367431640625e+42
;
;guess: 9.5367431640625e+42
;(/ x guess): 1048576.0
;next guess: 4.76837158203125e+42
;
;guess: 4.76837158203125e+42
;(/ x guess): 2097152.0
;next guess: 2.384185791015625e+42
;
;guess: 2.384185791015625e+42
;(/ x guess): 4194304.0
;next guess: 1.1920928955078124e+42
;
;guess: 1.1920928955078124e+42
;(/ x guess): 8388608.0
;next guess: 5.960464477539062e+41
;
;guess: 5.960464477539062e+41
;(/ x guess): 16777216.0
;next guess: 2.980232238769531e+41
;
;guess: 2.980232238769531e+41
;(/ x guess): 33554432.0
;next guess: 1.4901161193847655e+41
;
;guess: 1.4901161193847655e+41
;(/ x guess): 67108864.0
;next guess: 7.450580596923828e+40
;
;guess: 7.450580596923828e+40
;(/ x guess): 134217728.0
;next guess: 3.725290298461914e+40
;
;guess: 3.725290298461914e+40
;(/ x guess): 268435456.0
;next guess: 1.862645149230957e+40
;
;guess: 1.862645149230957e+40
;(/ x guess): 536870912.0
;next guess: 9.313225746154785e+39
;
;guess: 9.313225746154785e+39
;(/ x guess): 1073741824.0
;next guess: 4.6566128730773923e+39
;
;guess: 4.6566128730773923e+39
;(/ x guess): 2147483648.0
;next guess: 2.3283064365386962e+39
;
;guess: 2.3283064365386962e+39
;(/ x guess): 4294967296.0
;next guess: 1.1641532182693481e+39
;
;guess: 1.1641532182693481e+39
;(/ x guess): 8589934592.0
;next guess: 5.8207660913467404e+38
;
;guess: 5.8207660913467404e+38
;(/ x guess): 17179869184.0
;next guess: 2.9103830456733702e+38
;
;guess: 2.9103830456733702e+38
;(/ x guess): 34359738368.0
;next guess: 1.4551915228366851e+38
;
;guess: 1.4551915228366851e+38
;(/ x guess): 68719476736.0
;next guess: 7.2759576141834255e+37
;
;guess: 7.2759576141834255e+37
;(/ x guess): 137438953472.0
;next guess: 3.6379788070917128e+37
;
;guess: 3.6379788070917128e+37
;(/ x guess): 274877906944.0
;next guess: 1.8189894035458564e+37
;
;guess: 1.8189894035458564e+37
;(/ x guess): 549755813888.0
;next guess: 9.094947017729282e+36
;
;guess: 9.094947017729282e+36
;(/ x guess): 1099511627776.0
;next guess: 4.547473508864641e+36
;
;guess: 4.547473508864641e+36
;(/ x guess): 2199023255552.0
;next guess: 2.2737367544323205e+36
;
;guess: 2.2737367544323205e+36
;(/ x guess): 4398046511104.0
;next guess: 1.1368683772161602e+36
;
;guess: 1.1368683772161602e+36
;(/ x guess): 8796093022208.0
;next guess: 5.684341886080801e+35
;
;guess: 5.684341886080801e+35
;(/ x guess): 17592186044416.0
;next guess: 2.8421709430404006e+35
;
;guess: 2.8421709430404006e+35
;(/ x guess): 35184372088832.0
;next guess: 1.4210854715202003e+35
;
;guess: 1.4210854715202003e+35
;(/ x guess): 70368744177664.0
;next guess: 7.1054273576010015e+34
;
;guess: 7.1054273576010015e+34
;(/ x guess): 140737488355328.0
;next guess: 3.5527136788005007e+34
;
;guess: 3.5527136788005007e+34
;(/ x guess): 281474976710656.0
;next guess: 1.7763568394002504e+34
;
;guess: 1.7763568394002504e+34
;(/ x guess): 562949953421312.0
;next guess: 8.881784197001252e+33
;
;guess: 8.881784197001252e+33
;(/ x guess): 1125899906842624.0
;next guess: 4.440892098500626e+33
;
;guess: 4.440892098500626e+33
;(/ x guess): 2251799813685248.0
;next guess: 2.220446049250313e+33
;
;guess: 2.220446049250313e+33
;(/ x guess): 4503599627370496.0
;next guess: 1.1102230246251565e+33
;
;guess: 1.1102230246251565e+33
;(/ x guess): 9007199254740992.0
;next guess: 5.5511151231257824e+32
;
;guess: 5.5511151231257824e+32
;(/ x guess): 18014398509481984.0
;next guess: 2.7755575615628912e+32
;
;guess: 2.7755575615628912e+32
;(/ x guess): 36028797018963970.0
;next guess: 1.3877787807814458e+32
;
;guess: 1.3877787807814458e+32
;(/ x guess): 72057594037927930.0
;next guess: 6.9388939039072325e+31
;
;guess: 6.9388939039072325e+31
;(/ x guess): 144115188075855780.0
;next guess: 3.4694469519536235e+31
;
;guess: 3.4694469519536235e+31
;(/ x guess): 288230376151710940.0
;next guess: 1.7347234759768261e+31
;
;guess: 1.7347234759768261e+31
;(/ x guess): 576460752303417150.0
;next guess: 8.673617379884419e+30
;
;guess: 8.673617379884419e+30
;(/ x guess): 1152921504606795900.0
;next guess: 4.336808689942786e+30
;
;guess: 4.336808689942786e+30
;(/ x guess): 2305843009213285400.0
;next guess: 2.168404344972546e+30
;
;guess: 2.168404344972546e+30
;(/ x guess): 4611686018424119000.0
;next guess: 1.0842021724885788e+30
;
;guess: 1.0842021724885788e+30
;(/ x guess): 9223372036828622000.0
;next guess: 5.421010862489011e+29
;
;guess: 5.421010862489011e+29
;(/ x guess): 18446744073500316000.0
;next guess: 2.710505431336739e+29
;
;guess: 2.710505431336739e+29
;(/ x guess): 3.689348814574521e+19
;next guess: 1.355252715852837e+29
;
;guess: 1.355252715852837e+29
;(/ x guess): 73786976281447055000.0
;next guess: 6.776263582953534e+28
;
;guess: 6.776263582953534e+28
;(/ x guess): 1.4757395248254722e+20
;next guess: 3.3881317988554645e+28
;
;guess: 3.3881317988554645e+28
;(/ x guess): 2.9514790432231922e+20
;next guess: 1.6940659141851275e+28
;
;guess: 1.6940659141851275e+28
;(/ x guess): 5.9029580350243675e+20
;next guess: 8.47032986607354e+27
;
;guess: 8.47032986607354e+27
;(/ x guess): 1.1805915658672624e+21
;next guess: 4.2351655233325526e+27
;
;guess: 4.2351655233325526e+27
;(/ x guess): 2.361182802633705e+21
;next guess: 2.1175839422576777e+27
;
;guess: 2.1175839422576777e+27
;(/ x guess): 4.722362972463054e+21
;next guess: 1.058794332310325e+27
;
;guess: 1.058794332310325e+27
;(/ x guess): 9.444704882561717e+21
;next guess: 5.294018885076038e+26
;
;guess: 5.294018885076038e+26
;(/ x guess): 1.8889241268462853e+22
;next guess: 2.6471038887443614e+26
;
;guess: 2.6471038887443614e+26
;(/ x guess): 3.7777134635782817e+22
;next guess: 1.3237408300453596e+26
;
;guess: 1.3237408300453596e+26
;(/ x guess): 7.554348837043379e+22
;next guess: 6.62248132464532e+25
;
;guess: 6.62248132464532e+25
;(/ x guess): 1.510008033210357e+23
;next guess: 3.3187907024887117e+25
;
;guess: 3.3187907024887117e+25
;(/ x guess): 3.0131457197650783e+23
;next guess: 1.6744610798431814e+25
;
;guess: 1.6744610798431814e+25
;(/ x guess): 5.972070727936257e+23
;next guess: 8.670908935612719e+24
;
;guess: 8.670908935612719e+24
;(/ x guess): 1.153281631055829e+24
;next guess: 4.912095283334275e+24
;
;guess: 4.912095283334275e+24
;(/ x guess): 2.0357911284677102e+24
;next guess: 3.473943205900992e+24
;
;guess: 3.473943205900992e+24
;(/ x guess): 2.878573254454351e+24
;next guess: 3.1762582301776713e+24
;
;guess: 3.1762582301776713e+24
;(/ x guess): 3.14835862682381e+24
;next guess: 3.162308428500741e+24
;
;guess: 3.162308428500741e+24
;(/ x guess): 3.1622468921353843e+24
;next guess: 3.162277660318063e+24
;
;guess: 3.162277660318063e+24
;(/ x guess): 3.1622776600186957e+24
;next guess: 3.162277660168379e+24
;
;guess: 3.162277660168379e+24
;(/ x guess): 3.1622776601683796e+24
;next guess: 3.162277660168379e+24
;
;guess: 3.162277660168379e+24
;(/ x guess): 3.1622776601683796e+24
;next guess: 3.162277660168379e+24
;
;guess: 3.162277660168379e+24
;(/ x guess): 3.1622776601683796e+24
;next guess: 3.162277660168379e+24
;
;guess: 3.162277660168379e+24
;(/ x guess): 3.1622776601683796e+24
;next guess: 3.162277660168379e+24

; 3.162277660168379+3.1622776601683796 = 6.3245553203367586
; 6.3245553203367586e+24 = 6324555320336758600000000
; 2進数表現で          10100111011010001101101010010110110111001000001000100011111001001100110001000000000
; これが丸め込まれると 10100111011010001101101010010110110111001000001000100000000000000000000000000000000
; 丸め込まれた値は 3.162277660168379e+24 となり、次のguessも同じ値となるため、その後の計算が進まなくなる
; racketでの浮動小数点は倍数制度で仮数部は52bitなのでこれを超える桁数の値は丸め込まれてしまうため以降の計算が進まなくなる

;
; 判定を変えた関数を作成する
;

(define (new-good-enough? guess next-guess)
  (< (/ (abs (- next-guess guess)) next-guess) 0.001))

(define (new-sqrt-iter guess x)
  (if (new-good-enough? guess (improve guess x))
      guess
      (new-sqrt-iter (improve guess x) x)))

(define (new-my-sqrt x)
  (new-sqrt-iter 1.0 x))

;(new-my-sqrt 0.0000000001)
;(new-my-sqrt 10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)

; どっちも動いた
